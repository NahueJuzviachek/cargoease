{% extends "home/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/index.css' %}" />

<div class="container my-4" style="max-width: 720px;">

  <!-- Título dinámico según si se edita o agrega -->
  <h2 class="titulo-clientes text-center">
    {% if object %}
      <span data-i18n="drivers.form.edit_title">Editar Conductor</span>
    {% else %}
      <span data-i18n="drivers.form.add_title">Agregar Conductor</span>
    {% endif %}
  </h2>

  <!-- Formulario de conductor -->
  <form method="post" class="mt-4" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Nombre y Apellido -->
    <div class="mb-3">
      <label class="form-label" data-i18n="drivers.form.label_name">{{ form.nombreApellido.label }}</label>
      {{ form.nombreApellido }}
      {{ form.nombreApellido.errors }}
    </div>

    <!-- DNI -->
    <div class="mb-3">
      <label class="form-label" data-i18n="drivers.form.label_dni">{{ form.dni.label }}</label>
      {{ form.dni }}
      {{ form.dni.errors }}
    </div>

    <!-- Selección de Vehículo -->
    <div class="mb-3">
      <label class="form-label" data-i18n="drivers.form.label_vehicle">{{ form.vehiculo.label }}</label>
      {{ form.vehiculo }}
      {{ form.vehiculo.errors }}
    </div>

    <!-- Dominio (readonly) -->
    <div class="mb-3">
      <label class="form-label" data-i18n="drivers.form.label_dominio">{{ form.dominio.label }}</label>
      {{ form.dominio }}
      <div class="form-text" data-i18n="drivers.form.dominio_help">Se completa automáticamente según el vehículo seleccionado.</div>
      {{ form.dominio.errors }}
    </div>

    <!-- Botones -->
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'conductores_list' %}" data-i18n="buttons.cancel">Cancelar</a>
      <button class="btn btn-success" type="submit" data-i18n="buttons.save">Guardar</button>
    </div>
  </form>
</div>

<!-- Script para actualizar dominio según vehículo -->
<script>
(function () {
  // obtén elementos con seguridad
  const select = document.getElementById("id_vehiculo");
  const domInput = document.getElementById("id_dominio");

  // si no existen, salimos sin error
  if (!select || !domInput) {
    console.warn('[drivers.form] id_vehiculo o id_dominio no encontrado. El script de dominios no se ejecutará.');
    return;
  }

  // construir el objeto sin comas finales para evitar errores de sintaxis
  const dominiosPorVehiculo = {
    {% for v in form.fields.vehiculo.queryset %}
      "{{ v.pk }}": "{{ v.dominio|escapejs }}" {% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  // Sincroniza dominio cuando se selecciona un vehículo
  function syncDominio() {
    const vid = select.value;
    domInput.value = Object.prototype.hasOwnProperty.call(dominiosPorVehiculo, vid) ? dominiosPorVehiculo[vid] : "";
  }

  // Inicializa y agrega listener
  try {
    syncDominio();
    select.addEventListener("change", syncDominio);
  } catch (err) {
    console.error('[drivers.form] error inicializando syncDominio:', err);
  }
})();
</script>

{% endblock %}
