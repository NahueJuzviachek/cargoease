{% extends "home/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/index.css' %}" />

<div class="container my-4" style="max-width: 720px;">
  <h2 class="titulo-clientes text-center">
    {% if object %}Editar Cliente{% else %}Agregar Cliente{% endif %}
  </h2>

  <form method="post" class="mt-4">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Nombre -->
    <div class="mb-3">
      <label class="form-label">{{ form.nombre.label }}</label>
      {{ form.nombre }}
      <div class="text-danger small">{{ form.nombre.errors }}</div>
    </div>

    <!-- Correo -->
    <div class="mb-3">
      <label class="form-label">{{ form.correo.label }}</label>
      {{ form.correo }}
      <div class="text-danger small">{{ form.correo.errors }}</div>
    </div>

    <!-- País -->
    <div class="mb-3">
      <label class="form-label">{{ form.pais.label }}</label>
      {{ form.pais }}
      <div class="text-danger small">{{ form.pais.errors }}</div>
    </div>

    <!-- Provincia -->
    <div class="mb-3">
      <label class="form-label">{{ form.provincia.label }}</label>
      {{ form.provincia }}
      <div class="text-danger small">{{ form.provincia.errors }}</div>
    </div>

    <!-- Localidad -->
    <div class="mb-3">
      <label class="form-label">{{ form.localidad.label }}</label>
      {{ form.localidad }}
      <div class="text-danger small">{{ form.localidad.errors }}</div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'clientes_list' %}">Cancelar</a>
      <button class="btn btn-success" type="submit">Guardar</button>
    </div>
  </form>
</div>

<!-- Script para selects dependientes -->
<script>
  (function () {
    const $ = (sel) => document.querySelector(sel);
    const paisSelect = $("#id_pais");
    const provinciaSelect = $("#id_provincia");
    const localidadSelect = $("#id_localidad");

    function resetSelect(el, placeholder) {
      el.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = placeholder;
      el.appendChild(opt);
    }

    paisSelect?.addEventListener("change", async function () {
      resetSelect(provinciaSelect, "— Seleccionar provincia —");
      resetSelect(localidadSelect, "— Seleccionar localidad —");
      const pais = this.value;
      if (!pais) return;
      const res = await fetch(`{% url 'ajax_cargar_provincias' %}?pais=${pais}`);
      const data = await res.json();
      data.forEach(p => {
        const o = document.createElement("option");
        o.value = p.id; o.textContent = p.nombre;
        provinciaSelect.appendChild(o);
      });
    });

    provinciaSelect?.addEventListener("change", async function () {
      resetSelect(localidadSelect, "— Seleccionar localidad —");
      const provincia = this.value;
      if (!provincia) return;
      const res = await fetch(`{% url 'ajax_cargar_localidades' %}?provincia=${provincia}`);
      const data = await res.json();
      data.forEach(l => {
        const o = document.createElement("option");
        o.value = l.id; o.textContent = l.nombre;
        localidadSelect.appendChild(o);
      });
    });
  })();
</script>
{% endblock %}