{% extends "home/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'home/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- Endpoints resueltos por Django -->
<div id="dashboard-endpoints" data-clientes-url="{% url 'data_clientes_top_mensual' %}"
  data-rankingkm-url="{% url 'data_ranking_km' %}" data-aceite-url="{% url 'data_aceite_top5' %}"
  data-neumaticos-url="{% url 'data_neumaticos_estado' %}">
</div>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Panel General</h2>
  </div>

  <div class="row g-3">

    <!-- Card 1: Clientes más recurrentes (mensual) -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="text-center">
              <i class="bi bi-people"></i>
              <h5 class="card-title mb-0 d-inline-block ms-2">Clientes más recurrentes (mensual)</h5>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
              data-bs-target="#modalFecha">
              Generar Reporte
            </button>
          </div>

          <div class="d-flex justify-content-center gap-2 mb-2">
            <input type="month" id="cliDesde" class="form-control form-control-sm" style="width: 150px;">
            <input type="month" id="cliHasta" class="form-control form-control-sm" style="width: 150px;">
            <button id="cliAplicar" class="btn btn-primary btn-sm">Aplicar</button>
          </div>

          <div class="chart-wrap">
            <canvas id="chartClientesTopMensual" height="160"></canvas>
            <div class="chart-empty d-none" id="emptyClientes">Sin datos para el período</div>
            <div class="chart-error d-none" id="errorClientes">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Ranking de vehículos con más km -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="text-center">
              <i class="bi bi-trophy"></i>
              <h5 class="card-title mb-0 d-inline-block ms-2">Ranking de vehículos por kilómetros</h5>
            </div>
            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalVehiculos">
              Generar reporte
            </button>
          </div>
          <div class="d-flex justify-content-center gap-2 mb-2">
            <input type="date" id="rkDesde" class="form-control form-control-sm" style="width: 140px;">
            <input type="date" id="rkHasta" class="form-control form-control-sm" style="width: 140px;">
            <button id="rkAplicar" class="btn btn-primary btn-sm">Aplicar</button>
          </div>
          <div class="chart-wrap">
            <canvas id="chartRankingKm" height="140"></canvas>
            <div class="chart-empty d-none" id="emptyRanking">Sin datos en el rango</div>
            <div class="chart-error d-none" id="errorRanking">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 3: Aceite Top 5 -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-center mb-3">
            <i class="bi bi-droplet-half"></i>
            <h5 class="card-title mb-0 d-inline-block ms-2">Aceite – Top 5 con menos Km. restantes</h5>
          </div>
          <div class="chart-wrap text-center">
            <canvas id="chartAceiteTop5" height="180"></canvas>
            <div class="chart-empty d-none" id="emptyAceite">No hay registros de aceite</div>
            <div class="chart-error d-none" id="errorAceite">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 4: Neumáticos estado global -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-center mb-3">
            <i class="bi bi-circle-half"></i>
            <h5 class="card-title mb-0 d-inline-block ms-2">Neumáticos – Estado global</h5>
          </div>
          <div class="chart-wrap text-center">
            <canvas id="chartNeumaticosEstado" height="180"></canvas>
            <div class="chart-empty d-none" id="emptyNeum">No hay neumáticos cargados</div>
            <div class="chart-error d-none" id="errorNeum">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Acceso a vehículos -->
  <div class="mt-3">
    {% url 'vehiculos_list' as vehs_url %}
    {% if vehs_url %}
    <a href="{{ vehs_url }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-truck"></i> Ver vehículos
    </a>
    {% else %}
    <span class="text-muted small">Listado de vehículos no disponible</span>
    {% endif %}
  </div>
</div>


<!-- Modal: Reporte de clientes -->
<div class="modal fade" id="modalFecha" tabindex="-1" aria-labelledby="modalFechaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalFechaLabel">Seleccionar rango de fechas (Mensual)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="reporteClientesForm" method="post" action="{% url 'generar_reporte_clientes' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="cliDesdeModal" class="form-label">Desde</label>
            <input type="month" class="form-control" id="cliDesdeModal" name="desde" required>
          </div>
          <div class="mb-3">
            <label for="cliHastaModal" class="form-label">Hasta</label>
            <input type="month" class="form-control" id="cliHastaModal" name="hasta" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" form="reporteClientesForm">Generar Reporte</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Reporte de vehículos -->
<div class="modal fade" id="modalVehiculos" tabindex="-1" aria-labelledby="modalVehiculosLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalVehiculosLabel">Seleccionar rango de fechas (Mensual)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="reporteVehiculosForm" method="post" action="{% url 'reporte_vehiculos' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="vehDesdeModal" class="form-label">Desde</label>
            <input type="month" class="form-control" id="vehDesdeModal" name="desde" required>
          </div>
          <div class="mb-3">
            <label for="vehHastaModal" class="form-label">Hasta</label>
            <input type="month" class="form-control" id="vehHastaModal" name="hasta" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" form="reporteVehiculosForm">Generar Reporte</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="{% static 'home/js/dashboard.js' %}?v=20251023"></script>
{% endblock %}