{% extends "home/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'home/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- Endpoints resueltos por Django -->
<div id="dashboard-endpoints" data-clientes-url="{% url 'data_clientes_top_mensual' %}"
  data-rankingkm-url="{% url 'data_ranking_km' %}" data-aceite-url="{% url 'data_aceite_top5' %}"
  data-neumaticos-url="{% url 'data_neumaticos_estado' %}">
</div>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Panel General – Flota</h2>
  </div>

  <div class="row g-3">
    <!-- Card 1: Clientes más recurrentes (mensual) -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-people"></i>
              <h5 class="card-title mb-0">Clientes más recurrentes (mensual)</h5>
            </div>
            <div class="d-flex gap-2">
              <input type="month" id="cliDesde" class="form-control form-control-sm" style="width: 150px;">
              <input type="month" id="cliHasta" class="form-control form-control-sm" style="width: 150px;">
              <button id="cliAplicar" class="btn btn-primary btn-sm">Aplicar</button>
            </div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartClientesTopMensual" height="160"></canvas>
            <div class="chart-empty d-none" id="emptyClientes">Sin datos para el período</div>
            <div class="chart-error d-none" id="errorClientes">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Ranking de vehículos con más km -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-trophy"></i>
              <h5 class="card-title mb-0">Ranking de vehículos por km</h5>
            </div>
            <div class="d-flex gap-2">
              <input type="date" id="rkDesde" class="form-control form-control-sm" style="width: 140px;">
              <input type="date" id="rkHasta" class="form-control form-control-sm" style="width: 140px;">
              <button id="rkAplicar" class="btn btn-primary btn-sm">Aplicar</button>
            </div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartRankingKm" height="140"></canvas>
            <div class="chart-empty d-none" id="emptyRanking">Sin datos en el rango</div>
            <div class="chart-error d-none" id="errorRanking">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 3: Aceite Top 5 -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center gap-2 mb-2">
            <i class="bi bi-droplet-half"></i>
            <h5 class="card-title mb-0">Aceite – Top 5 con menos km restantes</h5>
          </div>
          <div class="chart-wrap">
            <canvas id="chartAceiteTop5" height="180"></canvas>
            <div class="chart-empty d-none" id="emptyAceite">No hay registros de aceite</div>
            <div class="chart-error d-none" id="errorAceite">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 4: Neumáticos estado global -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center gap-2 mb-2">
            <i class="bi bi-circle-half"></i>
            <h5 class="card-title mb-0">Neumáticos – Estado global</h5>
          </div>
          <div class="chart-wrap">
            <canvas id="chartNeumaticosEstado" height="180"></canvas>
            <div class="chart-empty d-none" id="emptyNeum">No hay neumáticos cargados</div>
            <div class="chart-error d-none" id="errorNeum">Error cargando datos</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Acceso a vehículos -->
  <div class="mt-3">
    {% url 'vehiculos_list' as vehs_url %}
    {% if vehs_url %}
    <a href="{{ vehs_url }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-truck"></i> Ver vehículos
    </a>
    {% else %}
    <span class="text-muted small">Listado de vehículos no disponible</span>
    {% endif %}
  </div>
</div>

<!-- cache busting con ?v=... -->
<script src="{% static 'home/js/dashboard.js' %}?v=20251023"></script>
{% endblock %}