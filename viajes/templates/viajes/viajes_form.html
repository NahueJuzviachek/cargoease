{% extends "home/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/index.css' %}" />

<div class="container my-4" style="max-width: 900px;">
    <h2 class="titulo-viajes text-center">
        {% if object %}
            <span data-i18n="vehicles.trips.form.title.edit">Editar Viaje</span>
        {% else %}
            <span data-i18n="vehicles.trips.form.title.add">Agregar Viaje</span>
        {% endif %}
    </h2>

    {# --- Nodo de configuración para JS (sin JS inline) --- #}
    <div id="viajes-config" data-ors-key="{{ ORS_API_KEY|default:'' }}"
        data-url-localidad-coords="{% url 'ajax_localidad_coords' %}"
        data-url-cliente-ubic="{% url 'ajax_cliente_ubicacion' %}"
        data-url-cargar-provincias="{% url 'ajax_cargar_provincias' %}"
        data-url-cargar-localidades="{% url 'ajax_cargar_localidades' %}"></div>

    <form method="post" class="mt-4">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- Datos generales -->
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label" data-i18n="vehicles.trips.form.label.fecha">{{ form.fecha.label }}</label>
                {{ form.fecha }}
                <div class="text-danger small">{{ form.fecha.errors }}</div>
            </div>
            <div class="col-md-8">
                <label class="form-label" data-i18n="vehicles.trips.form.label.cliente">{{ form.cliente.label }}</label>
                {{ form.cliente }}
                <div class="text-danger small">{{ form.cliente.errors }}</div>
            </div>
        </div>

        <!-- Salida / Destino -->
        <div class="row g-4 mt-1">
            <div class="col-md-6">
                <div class="border rounded p-3 h-100">
                    <h5 class="mb-3" data-i18n="vehicles.trips.form.section.origin">Salida</h5>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="vehicles.trips.form.label.salida_pais">{{ form.salida_pais.label }}</label>
                        {{ form.salida_pais }}
                        <div class="text-danger small">{{ form.salida_pais.errors }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="vehicles.trips.form.label.salida_provincia">{{ form.salida_provincia.label }}</label>
                        {{ form.salida_provincia }}
                        <div class="text-danger small">{{ form.salida_provincia.errors }}</div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label" data-i18n="vehicles.trips.form.label.salida_localidad">{{ form.salida_localidad.label }}</label>
                        {{ form.salida_localidad }}
                        <div class="text-danger small">{{ form.salida_localidad.errors }}</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="border rounded p-3 h-100">
                    <h5 class="mb-3" data-i18n="vehicles.trips.form.section.destination">Destino</h5>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="vehicles.trips.form.label.destino_pais">{{ form.destino_pais.label }}</label>
                        {{ form.destino_pais }}
                        <div class="text-danger small">{{ form.destino_pais.errors }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="vehicles.trips.form.label.destino_provincia">{{ form.destino_provincia.label }}</label>
                        {{ form.destino_provincia }}
                        <div class="text-danger small">{{ form.destino_provincia.errors }}</div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label" data-i18n="vehicles.trips.form.label.destino_localidad">{{ form.destino_localidad.label }}</label>
                        {{ form.destino_localidad }}
                        <div class="text-danger small">{{ form.destino_localidad.errors }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Económicos -->
        <div class="row g-3 mt-3">
            <div class="col-md-3">
                <label class="form-label" data-i18n="vehicles.trips.form.label.distancia">{{ form.distancia.label }}</label>
                {{ form.distancia }}
                <div class="form-text" data-i18n="vehicles.trips.form.km_note">Los Km que se cargan de manera automatica son APROXIMADOS.</div>
                <div class="text-danger small">{{ form.distancia.errors }}</div>
            </div>
            <div class="col-md-3">
                <label class="form-label" data-i18n="vehicles.trips.form.label.divisa">{{ form.divisa.label }}</label>
                {{ form.divisa }}
                <div class="text-danger small">{{ form.divisa.errors }}</div>
            </div>
            <div class="col-md-3">
                <label class="form-label" data-i18n="vehicles.trips.form.label.valor_flete">{{ form.valor_flete.label }}</label>
                {{ form.valor_flete }}
                <div class="text-danger small">{{ form.valor_flete.errors }}</div>
            </div>
            <div class="col-md-3">
                <label class="form-label" data-i18n="vehicles.trips.form.label.porcentaje_conductor">{{ form.porcentaje_conductor.label }}</label>
                {{ form.porcentaje_conductor }}
                <div class="form-text" data-i18n="vehicles.trips.form.driver_pct_note">Porcentaje (0–100).</div>
                <div class="text-danger small">{{ form.porcentaje_conductor.errors }}</div>
            </div>
            <div class="col-md-3">
                <label class="form-label" data-i18n="vehicles.trips.form.label.viaticos">{{ form.viaticos.label }}</label>
                {{ form.viaticos }}
                <div class="text-danger small">{{ form.viaticos.errors }}</div>
            </div>
        </div>

        <div class="d-flex gap-2 mt-4">
            <a class="btn btn-outline-secondary" href="{% url 'vehiculo_viajes_list' vehiculo.pk %}" data-i18n="vehicles.trips.form.cancel">Cancelar</a>
            <button class="btn btn-success" type="submit" data-i18n="vehicles.trips.form.save">Guardar</button>
        </div>
    </form>
</div>

<!-- Mapa -->
<div class="card mt-4">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <div>
            <strong data-i18n="vehicles.trips.map.title">Vista del recorrido</strong>
            <small class="text-muted d-block" data-i18n="vehicles.trips.map.subtitle">Para rutas largas se usa segmentación automática</small>
        </div>
        <div id="route-meta" class="small text-muted"></div>
    </div>
    <div class="card-body p-0">
        <div id="map" style="height: 420px;"></div>
    </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Estilos y scripts -->
<link rel="stylesheet" href="{% static 'viajes/viajes_map.css' %}">
<script src="{% static 'viajes/viajes.js' %}?v=1"></script>
<script src="{% static 'viajes/viajes_map.js' %}?v=20251001"></script>
{% endblock %}
